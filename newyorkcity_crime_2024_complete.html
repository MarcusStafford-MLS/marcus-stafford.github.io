<!DOCTYPE html>
<!-- UCLA GEOG 414 Final Project. This relates to National Parks in the United States. -->

<html>
<head>
<meta charset="utf-8"/>
<!-- TO DO: Add a map title -->
<title>Arrest Statistics in New York City</title>

<!-- Needed links and references -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<!-- Needed scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://colorbrewer2.org/export/colorbrewer.js"></script>
<script src="nyc_crime_2024.js"></script>

<!-- CSS styling -->
<style>
    /* Custom CSS for map and legend */
    #map {
        height: 800px;
        margin-top: 50px;
        position: relative;
    }
    #map path:hover {
        fill: rgba(0, 0, 255, 0.5); /* Semi-transparent blue */
        stroke: rgba(255, 255, 0, 1); /* Fully opaque yellow */
        stroke-width: 3px; /* Increased stroke width */
    }
    #legend { 
        background-color: #ffffff;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        max-width: 300px;
        position: absolute;
        bottom: 175px;
        left: 350px;
        z-index: 1000; /* Ensure it's above the map */
    }
    #legend-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .legend-row {
        margin-bottom: 5px;
        display: flex;
        align-items: center;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border: 1px solid #aaa;
        margin-right: 5px;
    }
    .legend-caption {
        font-size: 14px;
    }
    .search-container {
        margin-top: 20px;
        margin-bottom: 20px;
    }
</style>
</head>
<body>
<!-- HTML content -->
<div class="container text-center">
    <div class="row">
        <div class="col">
            <h3>Arrest statistics in New York City</h3>
            <h6>This is a breakdown of every arrest effected in NYC by the NYPD from March 1st through March 14th in 2024</h6>
        </div>
    </div>
    <hr/>
    <div class="row"> 
        <div class="col">
            <p>Please select a data variable below:</p>
            <select id="select-variable" class="form-select" aria-label="Variable Selection" onchange="drawMap()">
                <option value="LAW_CAT_CD" selected>Offense level (felony, misdemeanor, violation)</option>
                <option value="ARREST_BORO">Designated Borough of Arrest (B(Bronx), S(Staten Island), K(Brooklyn), M(Manhattan), Q(Queens))</option>
                <option value="AGE_GROUP">Perpetrators Arrest Range of Age</option>
            </select>
            <hr/>
            
            <!-- Search container -->
            <div class="search-container">
                <label for="search-input" class="form-label">Search Perpetrator Gender (M/F):</label>
                <div class="input-group mb-3">
                    <input type="text" id="search-input" class="form-control" placeholder="Enter M or F" aria-label="Enter M or F" aria-describedby="button-search">
                    <button class="btn btn-outline-primary" type="button" id="button-search" onclick="searchGender()">Search</button>
                </div>
            </div>
            
            <div id="map"></div>
            <div id="legend"></div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
// Global variables
let selected_variable = "LAW_CAT_CD";
let datalayer = null;

// Data resources
const resources = {
    "LAW_CAT_CD": {
        'domain': ['F', 'M', 'V'],
        'labels': ['Felony', 'Misdemeanor', 'Violation'],
        'legend_label': 'Offense Level',
        'colorScheme': 'YlGn'
    },
    "AGE_GROUP": {
        'domain': ['<0', '18-24', '25-44', '45-64', '65+'],
        'labels': ['< 18', '18 - 24', '25 - 44', '45 - 64', '65+'],
        'legend_label': 'Arrest by Age',
        'colorScheme': 'YlGnBu'
    },
    "ARREST_BORO": {
        'domain': ['B', 'S', 'K', 'M', 'Q'],
        'labels': ['Bronx', 'Staten Island', 'Brooklyn', 'Manhattan', 'Queens'],
        'legend_label': 'Arrest by Borough',
        'colorScheme': 'Set2'
    },
    "PERP_SEX": {
        'domain': ['M', 'F'],
        'labels': ['Male', 'Female'],
        'legend_label': 'Perpetrator Gender',
        'colorScheme': 'PuOr'
    }
};

// Function to fill color based on selected variable
function fillColor(value) {
    let c;
    if (selected_variable === 'LAW_CAT_CD') {
        c = colorbrewer['YlGn'][3];
    } else if (selected_variable === 'AGE_GROUP') {
        c = colorbrewer['YlGnBu'][5];
    } else if (selected_variable === 'ARREST_BORO') {
        c = colorbrewer['Set2'][5];
    } else if (selected_variable === 'PERP_SEX') {
        c = colorbrewer['PuOr'][3];
    } else {
        c = colorbrewer['Reds'][5];
    }
    for (let i = 4; i >= 0; i--) {
        if (value === resources[selected_variable]['domain'][i]) {
            return c[i];
        }
    }
    return c[0]; // Default to the lowest color if no value matches
}

// Map initialization
let map = L.map('map').setView([40.76, -73.97], 11.2);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 20
}).addTo(map);

// Function to draw map
function drawMap() {
    let variableSelect = document.getElementById("select-variable");
    selected_variable = variableSelect.options[variableSelect.selectedIndex].value;

    if (datalayer != null) {
        map.removeLayer(datalayer);
    }

    datalayer = L.geoJSON(crime, {
        pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 3,
                fillColor: fillColor(feature.properties[selected_variable]),
                color: fillColor(feature.properties[selected_variable]),
                weight: 2,
                fillOpacity: 0.6,
                opacity: 0.6
            });
        }
    }).bindTooltip(function(layer) {
        return `
            <div style="text-align: left;">
                <h3 style="margin: 0; padding: 0;">Arrest Info</h3>
                <hr style="margin: 5px 0;">
                <strong>Perpetrator Male/Female: </strong>${layer.feature.properties.PERP_SEX}<br>
                <strong>Perpetrator Race: </strong>${layer.feature.properties.PERP_RACE}<br>
                <strong>Precinct at the time of Arrest: </strong>${layer.feature.properties.ARREST_PRECINCT}<br>
                <strong>Internal Classification: </strong>${layer.feature.properties.OFNS_DESC}<br>
                <strong>Arrest Date: </strong>${layer.feature.properties.ARREST_DATE}
            </div>
        `;  
    }).addTo(map);

    updateLegend();
}

// Function to update legend
function updateLegend() {
    let legendTitle = resources[selected_variable]['legend_label'];
    let legendLabels = resources[selected_variable]['labels'];
    let legendItems = '';

    document.getElementById("legend").innerHTML = `<div id="legend-title">${legendTitle}</div>`;
    
    for (let i = 0; i < legendLabels.length; i++) {
        legendItems += `
            <div class='legend-row'>
                <div class='legend-color' style='background-color: ${colorbrewer[resources[selected_variable].colorScheme][8][i]};'></div>
                <div class='legend-caption'>${legendLabels[i]}</div>
            </div>`;
    }
    
    document.getElementById("legend").innerHTML += legendItems;
}

// Function to search and highlight based on gender
function searchGender() {
    let searchInput = document.getElementById("search-input").value.toUpperCase();
    if (searchInput !== 'M' && searchInput !== 'F') {
        alert("Please enter 'M' or 'F' for gender search.");
        return;
    }

    // Clear previous highlights
    map.removeLayer(datalayer);

    // Filter data by gender
    let filteredData = crime.features.filter(feature => feature.properties.PERP_SEX === searchInput);

    // Create new GeoJSON layer with filtered data
    datalayer = L.geoJSON(filteredData, {
        pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 3,
                fillColor: fillColor(feature.properties[selected_variable]),
                color: fillColor(feature.properties[selected_variable]),
                weight: 2,
                fillOpacity: 0.6,
                opacity: 0.6
            });
        }
    }).bindTooltip(function(layer) {
        return `
            <div style="text-align: left;">
                <h3 style="margin: 0; padding: 0;">Arrest Info</h3>
                <hr style="margin: 5px 0;">
                <strong>Perpetrator Male/Female: </strong>${layer.feature.properties.PERP_SEX}<br>
                <strong>Perpetrator Race: </strong>${layer.feature.properties.PERP_RACE}<br>
                <strong>Precinct at the time of Arrest: </strong>${layer.feature.properties.ARREST_PRECINCT}<br>
                <strong>Internal Classification: </strong>${layer.feature.properties.OFNS_DESC}<br>
                <strong>Arrest Date: </strong>${layer.feature.properties.ARREST_DATE}
            </div>
        `;  
    }).addTo(map);

    updateLegend();
}

// Initial draw on page load
drawMap();
</script>
</body>
</html>
